<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Manager - EST1 Adv March</title>

    <!-- === ONESIGNAL NOTIFICATIONS === -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "b58e7b17-b719-486a-9d7b-5cb98d8533c3",
          path: "/Student-Manger/", 
          serviceWorkerParam: { scope: "/Student-Manger/" },
        });
      });
    </script>

    <!-- === CLERK AUTH === -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_ZXhjaXRpbmctbWFzdGlmZi04MC5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://exciting-mastiff-80.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript">
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        :root {
            --primary-color: #0F9E99;
            --primary-hover: #0b7a76;
            --bg-color: #EFE9E0;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --accent-green: #25D366;
            --error-red: #d32f2f;
            --pending-orange: #f59e0b;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
        }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        /* Tab Animations */
        .tab-btn { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--primary-color); color: var(--primary-color); background-color: rgba(15, 158, 153, 0.05); }

        /* Skeleton Loading */
        .skeleton {
            background-color: #e5e7eb;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* Toast Notifications */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms ease-in; }

        .modal { transition: opacity 0.25s ease; }
        .modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none w-full max-w-sm px-4 sm:px-0"></div>

    <!-- Header & Search Area -->
    <div class="sticky top-0 z-20 shadow-md bg-white">
        <!-- Main Header -->
        <header class="bg-[var(--primary-color)] text-white">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center"><i class="fas fa-user-graduate mr-2"></i>EST1 Adv March</h1>
                
                <div class="flex gap-2 items-center">
                    <button onclick="requestNotificationPermission()" id="notifyBtn" class="bg-white/20 text-white px-3 py-2 rounded-full font-bold text-sm hover:bg-white/30 transition backdrop-blur-sm" title="Enable Notifications">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button onclick="fetchStudents(true)" class="bg-white/20 text-white px-3 py-2 rounded-full font-bold text-sm hover:bg-white/30 transition backdrop-blur-sm" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <!-- Add button only shows on Active tab -->
                    <button id="addNewBtn" onclick="openAddModal()" class="bg-white text-[var(--primary-color)] px-4 py-2 rounded-full font-bold text-sm hover:bg-gray-100 transition shadow-sm">
                        + Add New
                    </button>
                    
                    <!-- Navbar placeholder -->
                    <div id="main-menu-container"></div>
                </div>
            </div>
        </header>

        <!-- GLOBAL SEARCH BAR -->
        <div class="bg-[var(--primary-color)] pb-3 px-4">
            <div class="container mx-auto">
                <div class="relative w-full">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-[var(--primary-color)] bg-transparent z-10 pointer-events-none">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="searchInput" placeholder="Search across all status (Name, Email, Phone)..." class="w-full pl-10 py-2 rounded-lg border-none focus:ring-2 focus:ring-white/50 bg-white text-gray-800 placeholder-gray-400 shadow-inner">
                </div>
            </div>
        </div>

        <!-- TABS (Status Bar) -->
        <div class="bg-white text-gray-500 shadow-sm border-t border-gray-100">
            <div class="container mx-auto px-4 flex">
                <button onclick="switchTab('active')" id="tab-active" class="tab-active tab-btn flex-1 py-3 font-semibold text-sm flex justify-center items-center gap-2 active">
                    <i class="fas fa-users"></i> Active <span id="count-active" class="bg-gray-100 text-gray-600 px-2 rounded-full text-xs">0</span>
                </button>
                <button onclick="switchTab('pending')" id="tab-pending" class="tab-btn flex-1 py-3 font-semibold text-sm flex justify-center items-center gap-2">
                    <i class="fas fa-clock"></i> Pending <span id="count-pending" class="bg-orange-100 text-orange-600 px-2 rounded-full text-xs">0</span>
                </button>
                <button onclick="switchTab('removed')" id="tab-removed" class="tab-btn flex-1 py-3 font-semibold text-sm flex justify-center items-center gap-2">
                    <i class="fas fa-archive"></i> Removed <span id="count-removed" class="bg-red-100 text-red-600 px-2 rounded-full text-xs">0</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        
        <!-- ACTIVE VIEW CONTROLS (Only visible in Active Tab) -->
        <div id="activeControls" class="flex justify-end mb-4">
            <!-- View Toggle -->
            <button onclick="toggleViewMode()" id="viewToggleBtn" class="bg-white text-gray-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-50 transition shadow-sm border border-gray-200">
                <i class="fas fa-th-large mr-1"></i> Change View
            </button>
        </div>

        <!-- GRIDS -->
        <!-- 1. Active Students Grid -->
        <div id="activeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <!-- 2. Pending Students Grid -->
        <div id="pendingGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <!-- 3. Removed Students Grid -->
        <div id="removedGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="text-gray-300 text-6xl mb-4"><i class="fas fa-folder-open"></i></div>
            <p class="text-gray-500 text-lg">No students found matching your criteria.</p>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-[var(--card-bg)] rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-[var(--primary-color)] p-4 flex justify-between items-center text-white">
                <h3 id="modalTitle" class="font-bold">Edit Student</h3>
                <button onclick="document.getElementById('addModal').classList.add('hidden')" class="hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="addForm" class="p-4 space-y-3">
                <input type="hidden" id="studentId">
                <input type="text" id="newName" placeholder="Full Name" required class="w-full border border-gray-200 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                <input type="email" id="newEmail" placeholder="Email" class="w-full border border-gray-200 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                <div class="grid grid-cols-2 gap-2">
                    <input type="tel" id="newStudentPhone" placeholder="Student Phone" class="w-full border border-gray-200 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                    <input type="tel" id="newParentPhone" placeholder="Parent Phone" class="w-full border border-gray-200 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="newPaid" placeholder="Paid ($)" class="w-full border border-gray-200 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                    <input type="number" id="newRemaining" placeholder="Remaining ($)" class="w-full border border-gray-200 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                </div>
                
                <div class="flex gap-2 mt-4 pt-2 border-t border-gray-100">
                    <button type="button" id="deleteBtn" onclick="deleteStudentAction(this)" class="px-4 bg-red-50 text-red-600 border border-red-100 py-2 rounded hover:bg-red-100 font-bold shadow-sm">Delete</button>
                    <button type="button" id="removeBtn" onclick="removeStudentAction(this)" class="px-4 bg-orange-50 text-orange-600 border border-orange-100 py-2 rounded hover:bg-orange-100 font-bold shadow-sm">Remove</button>
                    <button type="submit" id="submitBtn" class="flex-1 bg-[var(--primary-color)] text-white py-2 rounded font-bold hover:bg-[var(--primary-hover)] shadow-md">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50" onclick="closeModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="relative aspect-square bg-gray-100 flex items-center justify-center">
                <button onclick="closeModal()" class="absolute top-2 right-2 z-10 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-black/70"><i class="fas fa-times"></i></button>
                <img id="modalImage" src="" class="object-cover w-full h-full">
            </div>
            <div class="p-4 bg-white text-center">
                <p class="text-sm text-gray-500 font-bold" id="modalStudentId">--</p>
            </div>
        </div>
    </div>

    <script src="navbar.js"></script>

    <script>
        // ================= CONFIGURATION =================
        const BASE_WEBHOOK = 'https://api.mark-attendance.com/webhook/EST1-Adv-March-';
        
        const URLS = {
            GET:     BASE_WEBHOOK + 'get',
            UPDATE:  BASE_WEBHOOK + 'update',
            REMOVE:  BASE_WEBHOOK + 'remove',
            DELETE:  BASE_WEBHOOK + 'delete',
            APPROVE: BASE_WEBHOOK + 'approve',
            DENY:    BASE_WEBHOOK + 'deny',
            RESTORE: BASE_WEBHOOK + 'restore'
        };

        const DEFAULT_IMAGE = 'https://drive.google.com/file/d/1XHdWjv1CwvYno0nqSH9LaGdtVomp5dKL/view?usp=drivesdk';
        const CACHE_KEY = 'est1_adv_march_data';
        const VIEW_MODE_KEY = 'est1_view_mode';

        // ================= STATE =================
        let allStudents = [];
        let currentTab = 'active'; 
        let viewMode = localStorage.getItem(VIEW_MODE_KEY) || 'grid';

        // DOM Elements
        const grids = {
            active: document.getElementById('activeGrid'),
            pending: document.getElementById('pendingGrid'),
            removed: document.getElementById('removedGrid')
        };
        const counts = {
            active: document.getElementById('count-active'),
            pending: document.getElementById('count-pending'),
            removed: document.getElementById('count-removed')
        };
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');

        // ================= INIT =================
        document.addEventListener('DOMContentLoaded', () => {
            if(window.OneSignalDeferred) {
                window.OneSignalDeferred.push(async function(OneSignal) {
                    const permission = await OneSignal.Notifications.permission;
                    if (permission) updateNotifyIcon(true);
                });
            }

            const cached = localStorage.getItem(CACHE_KEY);
            if(cached) {
                try {
                    allStudents = JSON.parse(cached);
                    processAndRender();
                    showToast("Loaded from cache", "info");
                } catch(e) { console.error("Cache parse error"); }
            }

            updateViewToggleIcon();
            fetchStudents(false);
        });

        // ================= FETCHING =================
        async function fetchStudents(force = false) {
            if(allStudents.length === 0 || force) {
                grids[currentTab].innerHTML = '<div class="col-span-full text-center text-gray-400 py-10"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading...</div>';
            }

            try {
                const res = await fetch(URLS.GET, { method: 'GET', cache: 'no-store' });
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                
                let rawList = Array.isArray(data) ? data : (data.data || data.body || []);
                
                allStudents = rawList.map((item, idx) => ({
                    id: item.id || item.ID || idx,
                    name: item.Name || "No Name",
                    email: item.Email || "",
                    phone: item["Student Phone"] || "",
                    parentPhone: item["Parent Phone"] || "",
                    paid: parseFloat(item.Paid) || 0,
                    remaining: parseFloat(item.Remaining) || 0,
                    status: (item.Status || "Active").toLowerCase(), 
                    notes: item.Notes || "",
                    ref: item.Reference || item.Ref || "N/A", 
                    image: item.Image || DEFAULT_IMAGE,
                    joinedDate: item.date || item.Date // Capture date for sending back later
                }));

                localStorage.setItem(CACHE_KEY, JSON.stringify(allStudents));
                processAndRender();
                if(force) showToast("Data refreshed", "success");

            } catch(e) {
                console.error(e);
                showToast("Failed to load data", "error");
                grids[currentTab].innerHTML = `<div class="col-span-full text-center text-red-400">Failed to load. <button onclick="fetchStudents(true)" class="underline">Retry</button></div>`;
            }
        }

        // ================= RENDERING =================
        function processAndRender() {
            // 1. FILTER GLOBAL LIST FIRST (Global Search)
            const term = searchInput.value.toLowerCase();
            const filteredAll = allStudents.filter(s => 
                !term || 
                s.name.toLowerCase().includes(term) || 
                s.email.toLowerCase().includes(term) ||
                s.phone.includes(term)
            );

            // 2. Separate Lists based on status
            const activeList = filteredAll.filter(s => s.status === 'active');
            const pendingList = filteredAll.filter(s => s.status === 'pending');
            const removedList = filteredAll.filter(s => s.status === 'removed' || s.status === 'denied'); 

            // 3. Update Counts
            counts.active.innerText = activeList.length;
            counts.pending.innerText = pendingList.length;
            counts.removed.innerText = removedList.length;

            // 4. Determine Target List based on Tab
            let targetList = [];
            let targetGrid = grids[currentTab];
            
            // Hide all grids, show current
            Object.values(grids).forEach(g => g.classList.add('hidden'));
            targetGrid.classList.remove('hidden');

            if(currentTab === 'active') {
                document.getElementById('activeControls').classList.remove('hidden');
                document.getElementById('addNewBtn').classList.remove('hidden');
                targetList = activeList;
            } 
            else if(currentTab === 'pending') {
                document.getElementById('activeControls').classList.add('hidden');
                document.getElementById('addNewBtn').classList.add('hidden');
                targetList = pendingList;
            } 
            else {
                document.getElementById('activeControls').classList.add('hidden');
                document.getElementById('addNewBtn').classList.add('hidden');
                targetList = removedList;
            }

            // 5. Render
            if(currentTab === 'active') renderActiveGrid(targetList, targetGrid);
            else if(currentTab === 'pending') renderPendingGrid(targetList, targetGrid);
            else renderRemovedGrid(targetList, targetGrid);

            // Empty State
            if(targetList.length === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');
        }

        // --- RENDER: ACTIVE (CLASSIC GRID/LIST) ---
        function renderActiveGrid(list, container) {
            container.className = viewMode === 'list' 
                ? 'grid grid-cols-1 gap-3' 
                : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';

            container.innerHTML = list.map((s, idx) => {
                const safeImg = (typeof s.image === 'string' ? s.image : (s.image[0]?.url || DEFAULT_IMAGE));
                const isPaidOff = s.remaining <= 0;
                const statusColor = isPaidOff ? 'bg-[var(--primary-color)] text-white' : 'bg-[var(--error-red)]/10 text-[var(--error-red)]';
                const statusText = isPaidOff ? 'Fully Paid' : 'Payment Due';
                const borderColor = isPaidOff ? 'border-[var(--primary-color)]' : 'border-[var(--error-red)]';
                const remainingColor = s.remaining > 0 ? 'text-[var(--error-red)]' : 'text-[var(--primary-color)]';
                let dateDisplay = s.joinedDate ? `<p class="text-xs text-gray-400 mt-1"><i class="far fa-calendar-alt mr-1"></i> ${new Date(s.joinedDate).toLocaleDateString()}</p>` : '';

                if(viewMode === 'list') return `
                    <div class="bg-[var(--card-bg)] rounded-xl card-shadow border-l-4 ${borderColor} p-3 flex flex-row items-center justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-base text-[var(--text-color)] truncate">${s.name}</h3>
                                <button onclick="openModal('${s.id}', '${safeImg}')" class="text-gray-400 hover:text-[var(--primary-color)] transition-colors"><i class="fas fa-image"></i></button>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${statusColor} whitespace-nowrap">${statusText}</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-500 gap-3 mt-1">
                                <span class="truncate max-w-[150px]"><i class="fas fa-envelope mr-1"></i> ${s.email}</span>
                                ${dateDisplay}
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right hidden sm:block">
                                <div class="text-xs text-gray-400">Remaining</div>
                                <div class="font-bold ${remainingColor}">$${s.remaining}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openEditModal('${s.id}')" class="w-8 h-8 flex items-center justify-center bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition"><i class="fas fa-edit"></i></button>
                            </div>
                        </div>
                    </div>`;

                return `
                    <div class="bg-[var(--card-bg)] rounded-xl card-shadow border-l-4 ${borderColor} p-5 flex flex-col">
                        <div class="flex justify-between items-start mb-3">
                            <div class="min-w-0 pr-2">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <h3 class="font-bold text-lg text-[var(--text-color)] break-words leading-tight">${s.name}</h3>
                                    <button onclick="openModal('${s.id}', '${safeImg}')" class="text-[var(--primary-color)] hover:text-[var(--primary-hover)] bg-gray-100 hover:bg-gray-200 w-7 h-7 flex items-center justify-center rounded-full transition-colors"><i class="fas fa-image text-xs"></i></button>
                                </div>
                                <p class="text-sm text-gray-500 truncate"><i class="fas fa-envelope mr-1"></i> ${s.email}</p>
                                ${dateDisplay}
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold ${statusColor} whitespace-nowrap flex-shrink-0">${statusText}</span>
                        </div>
                        <div class="mb-4">
                            <p class="text-xs text-gray-400 uppercase mb-1">Notes</p>
                            <div class="relative group">
                                <input type="text" id="note-input-${idx}" value="${s.notes}" class="w-full text-sm py-2 px-3 border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none transition-all pr-12" placeholder="Add note...">
                                <button onclick="saveNote('${s.id}', ${idx}, 'note-input-${idx}', this)" class="absolute top-1/2 -translate-y-1/2 right-2 text-xs bg-white text-[var(--primary-color)] border border-gray-200 hover:bg-gray-50 px-2 py-1 rounded shadow-sm opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity">Save</button>
                            </div>
                        </div>
                        <div class="border-t border-gray-100 pt-3 flex justify-between items-center">
                            <div class="text-sm"><span class="text-gray-400">Paid:</span> <span class="font-bold text-[var(--text-color)]">$${s.paid}</span></div>
                            <div class="text-sm"><span class="text-gray-400">Remaining:</span> <span class="font-bold ${remainingColor}">$${s.remaining}</span></div>
                        </div>
                        <div class="mt-3 grid grid-cols-2 gap-2">
                             <a href="https://wa.me/${s.phone.replace(/^0/, '20')}" target="_blank" class="flex items-center justify-center bg-[#25D366]/10 text-[#25D366] py-2 rounded text-sm hover:bg-[#25D366]/20 transition border border-[#25D366]/20"><i class="fab fa-whatsapp text-lg mr-2"></i> Student</a>
                             <a href="https://wa.me/${s.parentPhone.replace(/^0/, '20')}" target="_blank" class="flex items-center justify-center bg-[#25D366]/10 text-[#25D366] py-2 rounded text-sm hover:bg-[#25D366]/20 transition border border-[#25D366]/20"><i class="fab fa-whatsapp text-lg mr-2"></i> Parent</a>
                             <button onclick="openEditModal('${s.id}')" class="flex items-center justify-center bg-gray-50 text-gray-600 py-2 rounded text-sm hover:bg-gray-100 transition border border-gray-200"><i class="fas fa-edit mr-2"></i> Edit</button>
                             <a href="https://ermathexpert.online/wp-admin/users.php?s=${encodeURIComponent(s.email)}" target="_blank" class="flex items-center justify-center bg-[var(--primary-color)]/10 text-[var(--primary-color)] py-2 rounded text-sm hover:bg-[var(--primary-color)]/20 transition border border-[var(--primary-color)]/20"><i class="fas fa-user-circle mr-2"></i> Account</a>
                        </div>
                    </div>`;
            }).join('');
        }

        // --- RENDER: PENDING (With Name+Image & Edit) ---
        function renderPendingGrid(list, container) {
            container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            container.innerHTML = list.map(s => {
                const safeImg = (typeof s.image === 'string' ? s.image : (s.image[0]?.url || DEFAULT_IMAGE));
                return `
                <div class="bg-white rounded-xl p-5 card-shadow border-l-4 border-orange-400 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-lg text-gray-800 leading-tight">${s.name}</h3>
                            <button onclick="openModal('${s.id}', '${safeImg}')" class="text-[var(--primary-color)] hover:text-[var(--primary-hover)] bg-gray-100 hover:bg-gray-200 w-7 h-7 flex items-center justify-center rounded-full transition-colors"><i class="fas fa-image text-xs"></i></button>
                        </div>
                        <button onclick="openEditModal('${s.id}')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-edit"></i></button>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1 mb-4 pl-1">
                        <p><span class="text-gray-400">Paid:</span> <span class="font-mono font-bold text-green-600">$${s.paid}</span></p>
                        <p><span class="text-gray-400">Ref #:</span> <span class="font-mono bg-gray-100 px-1 rounded">${s.ref}</span></p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="performAction('approve', '${s.id}', this)" class="py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold shadow-sm transition">Approve</button>
                        <button onclick="performAction('deny', '${s.id}', this)" class="py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-sm font-bold transition">Deny</button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- RENDER: REMOVED (With Name+Image & Edit) ---
        function renderRemovedGrid(list, container) {
            container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            container.innerHTML = list.map((s, idx) => {
                const safeImg = (typeof s.image === 'string' ? s.image : (s.image[0]?.url || DEFAULT_IMAGE));
                return `
                <div class="bg-gray-50 rounded-xl p-5 border border-gray-200 opacity-90 hover:opacity-100 transition">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-gray-700 line-through decoration-gray-400">${s.name}</h3>
                            <button onclick="openModal('${s.id}', '${safeImg}')" class="text-[var(--primary-color)] hover:text-[var(--primary-hover)] bg-gray-100 hover:bg-gray-200 w-7 h-7 flex items-center justify-center rounded-full transition-colors"><i class="fas fa-image text-xs"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded">Archived</span>
                            <button onclick="openEditModal('${s.id}')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-edit"></i></button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="note-${idx}" value="${s.notes}" class="flex-1 text-sm p-2 border rounded bg-white" placeholder="Add note...">
                            <button onclick="saveNote('${s.id}', ${idx}, 'note-${idx}', this)" class="bg-blue-50 text-blue-600 px-3 rounded hover:bg-blue-100"><i class="fas fa-save"></i></button>
                        </div>
                    </div>

                    <button onclick="performAction('restore', '${s.id}', this)" class="w-full py-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition">
                        <i class="fas fa-undo"></i> Restore Student
                    </button>
                </div>`;
            }).join('');
        }

        // ================= ACTIONS =================
        
        // NEW WRAPPER FUNCTIONS for Delete/Remove
        function deleteStudentAction(btn) {
            const id = document.getElementById('studentId').value;
            performAction('delete', id, btn);
        }

        function removeStudentAction(btn) {
            const id = document.getElementById('studentId').value;
            performAction('remove', id, btn);
        }

        async function performAction(actionType, id, btnElement) {
            let url = '';
            let method = 'POST';
            let confirmMsg = "";

            const student = allStudents.find(s => s.id == id);
            let body = { 
                id: id, 
                Date: student ? student.joinedDate : null 
            };

            switch(actionType) {
                case 'approve': url = URLS.APPROVE; break;
                case 'deny':    url = URLS.DENY; confirmMsg = "Deny this student? They will be moved to Removed."; break;
                case 'restore': url = URLS.RESTORE; break;
                case 'remove':  url = URLS.REMOVE; confirmMsg = "Archive this student?"; break;
                case 'delete':  url = URLS.DELETE; confirmMsg = "PERMANENTLY DELETE? This cannot be undone."; break;
            }

            if(confirmMsg && !confirm(confirmMsg)) return;

            const btn = btnElement;
            const originalContent = btn ? btn.innerHTML : '';
            if(btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            try {
                await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                showToast(`${actionType.toUpperCase()} Request Sent`, "success");
                
                if(actionType === 'remove' || actionType === 'delete') {
                    document.getElementById('addModal').classList.add('hidden');
                }

                // WAIT 4 SECONDS before fetching new data (backend delay)
                if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                await new Promise(resolve => setTimeout(resolve, 4000));

                await fetchStudents(true);

            } catch(e) {
                showToast("Action Failed", "error");
                if(btn) {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }
        }

        async function saveNote(id, idx, inputId, btnElement) {
            const val = document.getElementById(inputId).value;
            const student = allStudents.find(s => s.id == id);
            const btn = btnElement;
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                await fetch(URLS.UPDATE, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        id: id, 
                        Notes: val,
                        Date: student ? student.joinedDate : null 
                    })
                });
                
                allStudents.find(s => s.id == id).notes = val;
                
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('text-green-600');
                showToast("Note Saved", "success");
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('text-green-600');
                    btn.disabled = false;
                }, 1500);
            } catch(e) { 
                showToast("Failed to save note", "error");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            btn.disabled = true;

            const idVal = document.getElementById('studentId').value;
            const existingStudent = allStudents.find(s => s.id == idVal);

            const payload = {
                id: idVal,
                Name: document.getElementById('newName').value,
                Email: document.getElementById('newEmail').value,
                "Student Phone": document.getElementById('newStudentPhone').value,
                "Parent Phone": document.getElementById('newParentPhone').value,
                Paid: document.getElementById('newPaid').value,
                Remaining: document.getElementById('newRemaining').value,
                Status: 'Active',
                Date: existingStudent ? existingStudent.joinedDate : new Date().toISOString()
            };

            try {
                await fetch(URLS.UPDATE, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                showToast("Student Saved", "success");
                document.getElementById('addModal').classList.add('hidden');
                
                await new Promise(r => setTimeout(r, 4000));
                fetchStudents(true);
            } catch(e) {
                showToast("Save Failed", "error");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'tab-active'));
            document.getElementById(`tab-${tab}`).classList.add('active', 'tab-active');
            processAndRender();
        }

        function toggleViewMode() {
            viewMode = viewMode === 'grid' ? 'list' : 'grid';
            localStorage.setItem(VIEW_MODE_KEY, viewMode);
            processAndRender();
        }

        function openEditModal(id) {
            const s = allStudents.find(stu => stu.id == id);
            if(!s) return;
            document.getElementById('studentId').value = s.id;
            document.getElementById('newName').value = s.name;
            document.getElementById('newEmail').value = s.email;
            document.getElementById('newStudentPhone').value = s.phone;
            document.getElementById('newParentPhone').value = s.parentPhone;
            document.getElementById('newPaid').value = s.paid;
            document.getElementById('newRemaining').value = s.remaining;
            
            document.getElementById('modalTitle').innerText = "Edit Student";
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('removeBtn').classList.remove('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        }

        function openAddModal() {
            document.getElementById('addForm').reset();
            document.getElementById('studentId').value = "";
            document.getElementById('modalTitle').innerText = "Add New Student";
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('removeBtn').classList.add('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        }

        function openModal(id, url) {
            document.getElementById('modalImage').src = convertDriveLink(url);
            document.getElementById('modalStudentId').innerText = id;
            const m = document.getElementById('imageModal');
            m.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            setTimeout(() => { m.children[1].classList.replace('scale-95', 'scale-100'); }, 10);
        }

        function closeModal() {
            const m = document.getElementById('imageModal');
            m.children[1].classList.replace('scale-100', 'scale-95');
            setTimeout(() => {
                m.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }, 200);
        }

        function convertDriveLink(url) {
            if (!url) return '';
            const match = url.match(/\/d\/([-\w]+)/) || url.match(/id=([-\w]+)/);
            return (match && match[1]) ? `https://lh3.googleusercontent.com/d/${match[1]}` : url;
        }

        searchInput.addEventListener('input', () => processAndRender());

        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            d.className = `p-4 rounded shadow-lg text-white mb-3 toast-enter ${color} flex items-center gap-3`;
            d.innerHTML = `<i class="fas fa-info-circle"></i> <span>${msg}</span>`;
            c.appendChild(d);
            requestAnimationFrame(() => { d.classList.remove('toast-enter'); d.classList.add('toast-enter-active'); });
            setTimeout(() => d.remove(), 3000);
        }

        function requestNotificationPermission() {
            window.OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.Notifications.requestPermission();
                updateNotifyIcon(true);
            });
        }
        function updateNotifyIcon(active) {
            const btn = document.getElementById('notifyBtn');
            if(active) {
                btn.classList.replace('bg-white/20', 'bg-[var(--primary-color)]');
                btn.querySelector('i').classList.replace('fa-bell', 'fa-bell-slash');
            }
        }
    </script>
</body>
</html>
